<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - Honors Festival</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="top-banner">
    <div class="brand">
      <img id="siteLogo" class="site-logo" alt="Site Logo">
      <div class="brand-text">
        <span id="siteName" class="site-name">Honors Festival</span>
        <span id="pageTitle" class="page-title">Student Dashboard</span>
      </div>
    </div>
    <div class="user-info" style="flex-direction: column; align-items: flex-end; gap: 0.75rem; width: 100%; max-width: 640px;">
      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: flex-end; width: 100%;">
        <span id="clubNameDisplay" class="event-info" style="display: none;"></span>
        <span id="eventSelectorContainer" style="display: none;">
          <select id="eventSelector" class="form-control" style="width: auto; min-width: 200px;" onchange="switchEvent()">
            <option value="">Select Event...</option>
          </select>
        </span>
        <span id="eventName" class="event-info"></span>
      </div>
      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: flex-end; width: 100%;">
        <span id="userName">Welcome, <strong id="userDisplayName" style="cursor: pointer; text-decoration: underline;" onclick="showEditMyProfile()" title="Click to edit your profile"></strong></span>
        <span id="checkInNumberDisplay" class="event-info" style="font-weight: bold;"></span>
        <button onclick="logout()" class="btn btn-outline">Logout</button>
      </div>
    </div>
  </div>

  <div id="eventStatusBanner" style="display: none;" class="status-banner status-banner-closed">
    <strong>⚠ Registration Not Open:</strong> You can view classes and your registered classes, but registration is not currently open for this event.
  </div>

  <div class="container">
    <div id="notifications"></div>

    <!-- Tabs for Staff users -->
    <div id="staffTabs" class="tabs" style="display: none;">
      <button class="tab active" data-tab="student" onclick="switchStudentTab('student', this)">Student View</button>
      <button class="tab" data-tab="myclasses" onclick="switchStudentTab('myclasses', this)">My Classes</button>
    </div>

    <!-- Student View Content -->
    <div id="studentViewContent">
    <div class="dashboard-split">
      <!-- Left Panel: Class Browser -->
      <div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Available Classes</h2>
          </div>

          <div class="class-filters">
            <select id="timeslotFilter" class="form-control">
              <option value="">All Timeslots</option>
            </select>
            <select id="teacherFilter" class="form-control">
              <option value="">All Teachers</option>
            </select>
          </div>

          <div id="classesList" class="mt-2">
            <p class="text-center">Loading classes...</p>
          </div>
        </div>
      </div>

      <!-- Right Panel: Calendar Grid -->
      <div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">My Schedule</h2>
          </div>
          <div id="scheduleGrid">
            <p class="text-center">Loading schedule...</p>
          </div>
        </div>

        <!-- Registered and Waitlisted Classes -->
        <div class="card mt-2">
          <div class="card-header">
            <h2 class="card-title">My Classes</h2>
          </div>
          <div id="myClasses">
            <p class="text-center">Loading...</p>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- My Classes Tab Content (for Staff) -->
    <div id="myClassesTabContent" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">My Classes</h2>
        </div>
        <div id="myTeachingClassesContent">
          <p class="text-center">Loading classes...</p>
        </div>
      </div>
      <div class="card" id="teachingRosterCard" style="display: none; margin-top: 20px;">
        <div class="card-header">
          <h2 class="card-title">Class Roster</h2>
        </div>
        <div id="teachingRosterContent">
          <p class="text-center">Select a class to view roster</p>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/utils.js"></script>
  <script>
    let currentEventId = null;
    let currentUserId = null;
    let allClasses = [];
    let myRegistrations = [];
    let availableEvents = [];

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', async () => {
      if (!checkAuth()) return;

      await applyBranding('Student Dashboard');

      const user = getCurrentUser();
      currentUserId = user.id;
      document.getElementById('userDisplayName').textContent = `${user.firstName} ${user.lastName}`;

      // Show tabs for Staff users
      if (user.role === 'Staff') {
        const staffTabs = document.getElementById('staffTabs');
        if (staffTabs) staffTabs.style.display = 'flex';
      }

      // Load user details to get check-in number
      try {
        const userResponse = await fetchWithAuth(`/api/users/${user.id}`);
        const userDetails = await userResponse.json();
        setClubName(userDetails?.ClubName || null);
        if (userDetails && userDetails.CheckInNumber) {
          document.getElementById('checkInNumberDisplay').textContent = `Check-In: #${userDetails.CheckInNumber}`;
        }
      } catch (error) {
        console.error('Error loading user details:', error);
        setClubName(null);
      }

      await loadEvents();
      await loadData();
    });

    // Tab switching for Staff users
    function switchStudentTab(tabName, clickedElement) {
      // Update tab UI
      document.querySelectorAll('#staffTabs .tab').forEach(t => t.classList.remove('active'));
      if (clickedElement) {
        clickedElement.classList.add('active');
      }

      // Show/hide content
      const studentView = document.getElementById('studentViewContent');
      const myClassesView = document.getElementById('myClassesTabContent');
      
      if (tabName === 'student') {
        if (studentView) studentView.style.display = 'block';
        if (myClassesView) myClassesView.style.display = 'none';
      } else if (tabName === 'myclasses') {
        if (studentView) studentView.style.display = 'none';
        if (myClassesView) myClassesView.style.display = 'block';
        renderMyTeachingClasses();
      }
    }

    // Render My Classes tab for Staff users
    async function renderMyTeachingClasses() {
      const container = document.getElementById('myTeachingClassesContent');
      if (!container || !currentEventId || !currentUserId) {
        if (container) container.innerHTML = '<p class="text-center">Please select an event first.</p>';
        return;
      }
      
      try {
        const classesResponse = await fetchWithAuth(`/api/classes/${currentEventId}?teacherId=${currentUserId}`);
        const myClasses = await classesResponse.json();
        
        if (myClasses.length === 0) {
          container.innerHTML = '<p class="text-center">No classes assigned to you as a teacher.</p>';
          return;
        }
        
        container.innerHTML = `
          <div class="form-group">
            <label for="teachingClassSelect">Select Class:</label>
            <select id="teachingClassSelect" class="form-control" onchange="loadTeachingRoster(this.value)">
              <option value="">-- Select a class --</option>
              ${myClasses.map(c => `<option value="${c.ID}">${c.HonorName} - ${c.TimeslotDate} ${c.TimeslotStartTime}</option>`).join('')}
            </select>
          </div>
        `;
      } catch (error) {
        console.error('Error loading my classes:', error);
        container.innerHTML = '<p class="text-center" style="color: #d32f2f;">Error loading classes</p>';
      }
    }

    // Load roster for selected class
    async function loadTeachingRoster(classId) {
      if (!classId) {
        const rosterCard = document.getElementById('teachingRosterCard');
        if (rosterCard) rosterCard.style.display = 'none';
        return;
      }
      
      const rosterContainer = document.getElementById('teachingRosterContent');
      const rosterCard = document.getElementById('teachingRosterCard');
      if (!rosterContainer || !rosterCard) return;
      
      try {
        const response = await fetchWithAuth(`/api/registrations/class/${classId}/roster`);
        const roster = await response.json();
        
        rosterCard.style.display = 'block';
        
        // Check event status to determine if attendance can be edited
        const currentEvent = availableEvents.find(e => e.ID === currentEventId);
        const isEventClosed = currentEvent && currentEvent.Status === 'Closed';
        const disabledAttr = isEventClosed ? 'disabled' : '';
        
        const tableHtml = `
          <table class="table">
            <thead>
              <tr>
                <th>Student Name</th>
                <th>Club</th>
                <th>Investiture Level</th>
                <th>Attended</th>
                <th>Completed</th>
              </tr>
            </thead>
            <tbody>
              ${roster.map(student => `
                <tr>
                  <td>${student.FirstName} ${student.LastName}</td>
                  <td>${student.ClubName || 'No Club'}</td>
                  <td>${student.InvestitureLevel || 'None'}</td>
                  <td>
                    <input type="checkbox" ${student.Attended ? 'checked' : ''} ${disabledAttr}
                      onchange="updateTeachingAttendance(${classId}, ${student.UserID}, 'Attended', this.checked)">
                  </td>
                  <td>
                    <input type="checkbox" ${student.Completed ? 'checked' : ''} ${disabledAttr}
                      onchange="updateTeachingAttendance(${classId}, ${student.UserID}, 'Completed', this.checked)">
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        
        const mobileCards = roster.map(student => {
          const attendedChecked = student.Attended ? 'checked' : '';
          const completedChecked = student.Completed ? 'checked' : '';
          
          const actionsHtml = `
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" ${attendedChecked} ${disabledAttr}
                  onchange="updateTeachingAttendance(${classId}, ${student.UserID}, 'Attended', this.checked)">
                <span>Attended</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem;">
                <input type="checkbox" ${completedChecked} ${disabledAttr}
                  onchange="updateTeachingAttendance(${classId}, ${student.UserID}, 'Completed', this.checked)">
                <span>Completed</span>
              </label>
            </div>
          `;
          
          return createMobileCard({
            'Student Name': `${student.FirstName} ${student.LastName}`,
            'Club': student.ClubName || 'No Club',
            'Investiture Level': student.InvestitureLevel || 'None'
          }, `${student.FirstName} ${student.LastName}`, actionsHtml);
        }).join('');
        
        rosterContainer.innerHTML = wrapResponsiveTable(tableHtml, mobileCards);
        
        if (isEventClosed) {
          const banner = document.createElement('div');
          banner.className = 'status-banner status-banner-closed';
          banner.style.marginBottom = '15px';
          banner.innerHTML = '<strong>⚠ Event Closed:</strong> Attendance cannot be edited for closed events.';
          rosterContainer.insertBefore(banner, rosterContainer.firstChild);
        }
      } catch (error) {
        console.error('Error loading roster:', error);
        rosterContainer.innerHTML = '<p class="text-center" style="color: #d32f2f;">Error loading roster</p>';
      }
    }

    // Update attendance for a student in a class
    async function updateTeachingAttendance(classId, userId, field, value) {
      try {
        const updateData = {};
        updateData[field] = value;

        const response = await fetchWithAuth(`/api/attendance/${classId}/${userId}`, {
          method: 'PUT',
          body: JSON.stringify(updateData)
        });

        if (response.ok) {
          showNotification('Attendance updated', 'success');
        } else {
          const error = await response.json().catch(() => ({ error: 'Failed to update attendance' }));
          showNotification(error.error || 'Error updating attendance', 'error');
        }
      } catch (error) {
        console.error('Error updating attendance:', error);
        showNotification('Error updating attendance', 'error');
      }
    }

    // Make functions globally available
    window.switchStudentTab = switchStudentTab;
    window.loadTeachingRoster = loadTeachingRoster;
    window.updateTeachingAttendance = updateTeachingAttendance;

    async function loadEvents() {
      try {
        // Get events where user's club participates
        const response = await fetchWithAuth('/api/events/my');
        availableEvents = await response.json();
        
        if (availableEvents.length === 0) {
          document.getElementById('eventName').textContent = 'No events available';
          showNotification('Your club is not participating in any active events.', 'info');
          return;
        }

        // Show event selector if multiple events
        const eventSelectorContainer = document.getElementById('eventSelectorContainer');
        const eventSelector = document.getElementById('eventSelector');
        const eventNameSpan = document.getElementById('eventName');

        if (availableEvents.length > 1) {
          eventSelectorContainer.style.display = 'block';
          eventSelector.innerHTML = '<option value="">Select Event...</option>';
          availableEvents.forEach(event => {
            const option = document.createElement('option');
            option.value = event.ID;
            option.textContent = `${event.Name} (${event.Status})`;
            eventSelector.appendChild(option);
          });
        } else {
          eventSelectorContainer.style.display = 'none';
        }

        // Get saved event from localStorage or default to first Live event or first event
        const savedEventId = localStorage.getItem('selectedEventId');
        let selectedEvent = availableEvents.find(e => e.ID.toString() === savedEventId) ||
                          availableEvents.find(e => e.Status === 'Live') ||
                          availableEvents[0];

        if (selectedEvent) {
          currentEventId = selectedEvent.ID;
          eventNameSpan.textContent = selectedEvent.Name;
          if (eventSelector) {
            eventSelector.value = selectedEvent.ID;
          }
          
          // Save to localStorage
          localStorage.setItem('selectedEventId', selectedEvent.ID);
          
          // Update status banner
          await checkEventStatus(selectedEvent);
        }
      } catch (error) {
        console.error('Error loading events:', error);
        showNotification('Error loading events: ' + error.message, 'error');
      }
    }

    async function switchEvent() {
      const eventSelector = document.getElementById('eventSelector');
      const selectedEventId = parseInt(eventSelector.value);
      
      if (!selectedEventId) {
        return;
      }

      const selectedEvent = availableEvents.find(e => e.ID === selectedEventId);
      if (!selectedEvent) {
        return;
      }

      currentEventId = selectedEventId;
      document.getElementById('eventName').textContent = selectedEvent.Name;
      localStorage.setItem('selectedEventId', selectedEventId);
      
      await checkEventStatus(selectedEvent);
      await loadData();
    }

    async function checkEventStatus(event = null) {
      try {
        // If event not provided, get current event
        if (!event && currentEventId) {
          const response = await fetchWithAuth(`/api/events/${currentEventId}`);
          event = await response.json();
        }

        if (!event) return;
        
        const banner = document.getElementById('eventStatusBanner');
        
        // Show banner if event is not Live (Closed or not Live yet)
        if (event.Status !== 'Live') {
          banner.style.display = 'block';
          banner.className = 'status-banner status-banner-closed';
          if (event.Status === 'Closed') {
            banner.innerHTML = '<strong>⚠ Registration Not Open:</strong> Registration is closed for this event. You can view classes but cannot register.';
          } else {
            banner.innerHTML = '<strong>⚠ Registration Not Open:</strong> Registration is not yet open for this event. You can view classes but cannot register.';
          }
        } else {
          banner.style.display = 'none';
        }
      } catch (error) {
        console.error('Error checking event status:', error);
      }
    }

    async function loadData() {
      if (!currentEventId) return;

      try {
        // Load classes
        const classesResponse = await fetchWithAuth(`/api/classes/${currentEventId}`);
        allClasses = await classesResponse.json();

        // Load my registrations
        const regResponse = await fetchWithAuth(`/api/registrations/user/${currentUserId}?eventId=${currentEventId}`);
        myRegistrations = await regResponse.json();

        // Load filters
        await loadFilters();
        renderClasses();
        renderSchedule();
        renderMyClasses();
      } catch (error) {
        console.error('Error loading data:', error);
        showNotification('Error loading data', 'error');
      }
    }

    async function loadFilters() {
      try {
        // Load timeslots
        const timeslotsResponse = await fetchWithAuth(`/api/timeslots/event/${currentEventId}`);
        const timeslots = await timeslotsResponse.json();
        
        const timeslotSelect = document.getElementById('timeslotFilter');
        const previousTimeslot = timeslotSelect.value;
        while (timeslotSelect.options.length > 1) {
          timeslotSelect.remove(1);
        }
        
        timeslots.forEach(ts => {
          const option = document.createElement('option');
          option.value = ts.ID;
          // Format timeslot for display (using global convertTo12Hour from utils.js)
          option.textContent = `${ts.Date} - ${convertTo12Hour(ts.StartTime)} to ${convertTo12Hour(ts.EndTime)}`;
          timeslotSelect.appendChild(option);
        });
        if (previousTimeslot && Array.from(timeslotSelect.options).some(opt => opt.value === previousTimeslot)) {
          timeslotSelect.value = previousTimeslot;
        } else {
          timeslotSelect.value = '';
        }
        
        // Load teachers
        const teachersMap = new Map();
        allClasses.forEach(c => {
          if (c.TeacherID && c.TeacherFirstName && c.TeacherLastName) {
            const key = `${c.TeacherID}`;
            if (!teachersMap.has(key)) {
              teachersMap.set(key, {
                id: c.TeacherID,
                name: `${c.TeacherFirstName} ${c.TeacherLastName}`
              });
            }
          }
        });
        
        const teacherSelect = document.getElementById('teacherFilter');
        const previousTeacher = teacherSelect.value;
        while (teacherSelect.options.length > 1) {
          teacherSelect.remove(1);
        }
        Array.from(teachersMap.values()).sort((a, b) => a.name.localeCompare(b.name)).forEach(teacher => {
          const option = document.createElement('option');
          option.value = teacher.id;
          option.textContent = teacher.name;
          teacherSelect.appendChild(option);
        });
        if (previousTeacher && Array.from(teacherSelect.options).some(opt => opt.value === previousTeacher)) {
          teacherSelect.value = previousTeacher;
        } else {
          teacherSelect.value = '';
        }
      } catch (error) {
        console.error('Error loading filters:', error);
      }
    }

    function renderClasses() {
      const container = document.getElementById('classesList');
      const timeslotFilter = document.getElementById('timeslotFilter').value;
      const teacherFilter = document.getElementById('teacherFilter').value;

      // Get current event status to determine if registration is allowed
      const currentEvent = availableEvents.find(e => e.ID === currentEventId);
      const isEventLive = currentEvent && currentEvent.Status === 'Live';

      // Filter classes - make sure we're not deduplicating
      const filtered = allClasses.filter(c => {
        // Always filter out inactive classes from student view
        if (!c.Active) return false;
        
        if (timeslotFilter && c.TimeslotID && c.TimeslotID.toString() !== timeslotFilter) return false;
        if (teacherFilter && c.TeacherID && c.TeacherID.toString() !== teacherFilter) return false;
        return true;
      });

      
      // Count classes by honor name and timeslot to check for duplicates
      const classesByHonorTimeslot = {};
      filtered.forEach(c => {
        const key = `${c.HonorName}_${c.TimeslotID}`;
        if (!classesByHonorTimeslot[key]) {
          classesByHonorTimeslot[key] = [];
        }
        classesByHonorTimeslot[key].push({
          ID: c.ID,
          Teacher: `${c.TeacherFirstName || ''} ${c.TeacherLastName || ''}`.trim() || 'TBA',
          Location: c.LocationName || 'TBA'
        });
      });

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-center">No classes available</p>';
        return;
      }

      const tableData = (() => {
        let renderedCount = 0;
        return filtered.map(c => {
                const location = `${c.LocationName || 'TBA'}`;
                const teacher = c.TeacherFirstName ? `${c.TeacherFirstName} ${c.TeacherLastName}` : 'TBA';
                
                // Check if user is registered for this class
                const isRegistered = myRegistrations.some(r => r.ClassID === c.ID);
              
              // Check if user has an enrolled class in this timeslot
              const hasEnrolledInTimeslot = myRegistrations.some(r => {
                return r.TimeslotID === c.TimeslotID && r.Status === 'Enrolled';
              });
              
              // Check if user has a waitlist spot for this class or any class in this timeslot
              const hasWaitlistForThisClass = myRegistrations.some(r => r.ClassID === c.ID && r.Status === 'Waitlisted');
              const hasWaitlistInTimeslot = myRegistrations.some(r => {
                return r.TimeslotID === c.TimeslotID && r.Status === 'Waitlisted';
              });
              
              const isFull = c.RemainingSpots <= 0;
              
              // Can register if: not registered for this class, not enrolled in timeslot, class not full
              const canRegister = !isRegistered && !hasEnrolledInTimeslot && !isFull;
              
              // Can waitlist if: not registered for this class, not waitlisted in timeslot, class is full
              const canWaitlist = !isRegistered && !hasWaitlistInTimeslot && isFull;
              
              // Format session time
              function convertTo12Hour(time24) {
                if (!time24) return '';
                const [hours, minutes] = time24.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
              }
              
              const sessionTime = c.TimeslotDate && c.TimeslotStartTime && c.TimeslotEndTime
                ? `${c.TimeslotDate}<br><small>${convertTo12Hour(c.TimeslotStartTime)} - ${convertTo12Hour(c.TimeslotEndTime)}</small>`
                : 'TBA';

              // Don't show this class at all if they're already registered for it
              if (isRegistered) {
                return null;
              }

              renderedCount++;

              // Determine action buttons - only show if event is Live
              let actionButtons = '';
              if (!isEventLive) {
                actionButtons = '<span style="color: #999;">Registration not open</span>';
              } else if (canRegister) {
                actionButtons = `<button onclick="register(${c.ID})" class="btn btn-primary btn-sm">Register</button>`;
              } else if (hasEnrolledInTimeslot && !canWaitlist && !isFull) {
                // Show light blue register button when there's a timeslot conflict (not full)
                actionButtons = `<button onclick="register(${c.ID})" class="btn btn-sm" style="background-color: #87CEEB; color: #000; border-color: #87CEEB;">Register</button>`;
              } else if (canWaitlist) {
                actionButtons = `<button onclick="waitlist(${c.ID})" class="btn btn-warning btn-sm">Waitlist</button>`;
              } else if (hasWaitlistInTimeslot && !canRegister) {
                actionButtons = '<span style="color: #999;">Already waitlisted for another class at this time</span>';
              }
              
              // Ensure each class is uniquely displayed - show all distinguishing info
              // Include class ID in data attribute for debugging
              // Make sure teacher and location are always visible, even if "TBA"
              const displayTeacher = teacher === 'TBA' ? '<span style="color: #999;">TBA</span>' : teacher;
              const displayLocation = location === 'TBA' ? '<span style="color: #999;">TBA</span>' : location;
              
              // Multi-session badge
              const multiSessionBadge = c.IsMultiSession && c.TotalSessions > 1
                ? `<span class="badge bg-info" style="font-size: 0.7em; margin-left: 5px;" title="Session ${c.SessionNumber} of ${c.TotalSessions}">Session ${c.SessionNumber}/${c.TotalSessions}</span>`
                : '';

              return {
                classId: c.ID,
                honorId: c.HonorID || '',
                teacherId: c.TeacherID || '',
                locationId: c.LocationID || '',
                timeslotId: c.TimeslotID || '',
                classGroupId: c.ClassGroupID || '',
                honorName: c.HonorName || 'Unknown',
                club: c.ClubName || 'N/A',
                teacher: displayTeacher,
                location: displayLocation,
                sessionTime: sessionTime,
                remainingSpots: c.RemainingSpots,
                actionButtons: actionButtons,
                canRegister: canRegister,
                canWaitlist: canWaitlist,
                isFull: isFull,
                isMultiSession: c.IsMultiSession,
                totalSessions: c.TotalSessions,
                sessionNumber: c.SessionNumber,
                multiSessionBadge: multiSessionBadge
              };
            }).filter(data => data !== null);
      })();
      
      const tableHtml = `
        <table class="table">
          <thead>
            <tr>
              <th>Honor Name</th>
              <th>Club</th>
              <th>Teacher</th>
              <th>Location</th>
              <th>Session Time</th>
              <th>Remaining Spots</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${tableData.map(c => `
              <tr data-class-id="${c.classId}" data-honor-id="${c.honorId}" data-teacher-id="${c.teacherId}" data-location-id="${c.locationId}" data-timeslot-id="${c.timeslotId}" data-class-group-id="${c.classGroupId}" style="${c.isMultiSession ? 'background: linear-gradient(to right, #e3f2fd 0%, transparent 100%);' : ''}">
                <td>${c.honorName}${c.multiSessionBadge}</td>
                <td>${c.club || '<span style="color: #999;">N/A</span>'}</td>
                <td>${c.teacher}</td>
                <td>${c.location}</td>
                <td>${c.sessionTime}</td>
                <td>${c.remainingSpots}</td>
                <td>
                  ${c.actionButtons}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      const mobileCards = tableData.map(c => {
        // Convert HTML session time to plain text
        const sessionTimePlain = c.sessionTime.replace(/<br\s*\/?>/gi, ' ').replace(/<small>/gi, '').replace(/<\/small>/gi, '').replace(/<[^>]*>/g, '').trim();
        
        const cardData = {
          'Honor Name': c.honorName,
          'Club': c.club,
          'Teacher': c.teacher.replace(/<[^>]*>/g, ''), // Strip HTML tags
          'Location': c.location.replace(/<[^>]*>/g, ''), // Strip HTML tags
          'Session Time': sessionTimePlain,
          'Remaining Spots': c.remainingSpots
        };
        
        // Add session info for multi-session classes
        if (c.isMultiSession && c.totalSessions > 1) {
          cardData['Session'] = `${c.sessionNumber} of ${c.totalSessions}`;
        }
        
        return createMobileCard(cardData, c.honorName, `<div class="card-row-actions">${c.actionButtons}</div>`);
      }).join('');
      
      container.innerHTML = wrapResponsiveTable(tableHtml, mobileCards);
    }

    function renderSchedule() {
      // Simplified schedule view for now
      const container = document.getElementById('scheduleGrid');
      const enrolled = myRegistrations.filter(r => r.Status === 'Enrolled');
      
      if (enrolled.length === 0) {
        container.innerHTML = '<p class="text-center">No enrolled classes</p>';
        return;
      }

      container.innerHTML = `
        <div class="timeslot-grid">
          <div class="timeslot-row">
            <strong>Timeslot</strong>
            <strong>Class</strong>
          </div>
          ${enrolled.map(r => {
            const multiSessionBadge = r.IsMultiSession && r.TotalSessions > 1
              ? `<span class="badge bg-info" style="font-size: 0.65em; margin-left: 5px;">Session ${r.SessionNumber}/${r.TotalSessions}</span>`
              : '';
            return `
            <div class="timeslot-row" style="${r.IsMultiSession ? 'background: linear-gradient(to right, #e3f2fd 0%, transparent 100%);' : ''}">
              <span>${formatDateTime(r.TimeslotDate, r.TimeslotStartTime, r.TimeslotEndTime)}</span>
              <span>
                <strong>${r.HonorName}</strong>${multiSessionBadge}<br>
                <small>${r.TeacherFirstName} ${r.TeacherLastName}</small>
              </span>
            </div>
          `;}).join('')}
        </div>
      `;
    }

    function renderMyClasses() {
      const container = document.getElementById('myClasses');
      
      if (myRegistrations.length === 0) {
        container.innerHTML = '<p class="text-center">No registered classes</p>';
        return;
      }

      const enrolled = myRegistrations.filter(r => r.Status === 'Enrolled');
      const waitlisted = myRegistrations.filter(r => r.Status === 'Waitlisted');

      container.innerHTML = `
        <h3>Registered Classes (${enrolled.length})</h3>
        ${enrolled.map(r => {
          const multiSessionBadge = r.IsMultiSession && r.TotalSessions > 1
            ? `<span class="badge bg-info" style="font-size: 0.65em; margin-left: 5px;">Session ${r.SessionNumber}/${r.TotalSessions}</span>`
            : '';
          const dropButtonText = r.IsMultiSession && r.TotalSessions > 1 ? 'Drop All Sessions' : 'Drop';
          return `
          <div style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.25rem; margin-bottom: 0.5rem;${r.IsMultiSession ? ' background: linear-gradient(to right, #e3f2fd 0%, transparent 100%);' : ''}">
            <strong>${r.HonorName}</strong>${multiSessionBadge}<br>
            <small>${formatDateTime(r.TimeslotDate, r.TimeslotStartTime, r.TimeslotEndTime)}</small><br>
            <button onclick="dropClass(${r.ID})" class="btn btn-danger btn-sm mt-1">${dropButtonText}</button>
          </div>
        `;}).join('')}
        
        ${waitlisted.length > 0 ? `
          <h3 class="mt-2">Waitlisted Classes (${waitlisted.length})</h3>
          ${waitlisted.map(r => {
            const multiSessionBadge = r.IsMultiSession && r.TotalSessions > 1
              ? `<span class="badge bg-info" style="font-size: 0.65em; margin-left: 5px;">Session ${r.SessionNumber}/${r.TotalSessions}</span>`
              : '';
            return `
            <div style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.25rem; margin-bottom: 0.5rem;${r.IsMultiSession ? ' background: linear-gradient(to right, #e3f2fd 0%, transparent 100%);' : ''}">
              <strong>${r.HonorName}</strong>${multiSessionBadge}<br>
              <small>Position ${r.WaitlistOrder} - ${formatDateTime(r.TimeslotDate, r.TimeslotStartTime, r.TimeslotEndTime)}</small><br>
              <button onclick="dropClass(${r.ID})" class="btn btn-danger btn-sm mt-1">Drop Waitlist</button>
            </div>
          `;}).join('')}
        ` : ''}
      `;
    }

    async function register(classId) {
      try {
        const response = await fetchWithAuth('/api/registrations', {
          method: 'POST',
          body: JSON.stringify({ ClassID: classId })
        });

        const data = await response.json();

        if (response.ok) {
          showNotification('Successfully registered!', 'success');
          await loadData();
        } else if (response.status === 409 && data.conflict) {
          // Show conflict modal for student (handles both single and multi-session conflicts)
          showConflictModalStudent(classId, data);
        } else {
          showNotification(data.error, 'error');
        }
      } catch (error) {
        showNotification('Error registering', 'error');
      }
    }
    
    function showConflictModalStudent(newClassId, conflictData) {
      const modal = document.createElement('div');
      modal.id = 'conflictModal';
      modal.className = 'modal';
      modal.style.display = 'flex';
      
      // Handle multi-session conflicts
      const isMultiSession = conflictData.isMultiSession && conflictData.conflicts && conflictData.conflicts.length > 0;
      const conflicts = isMultiSession ? conflictData.conflicts : [{ 
        conflictClassName: conflictData.conflictClassName,
        conflictRegistrationId: conflictData.conflictRegistrationId
      }];
      
      // Build the conflict list HTML
      const conflictListHtml = conflicts.map(c => {
        const timeInfo = c.timeslotDate ? ` (${c.timeslotDate})` : '';
        return `<li style="margin-bottom: 8px;"><strong>${c.conflictClassName}</strong>${timeInfo}</li>`;
      }).join('');
      
      // Store conflict registration IDs for resolving
      const registrationIds = conflicts.map(c => c.conflictRegistrationId).join(',');
      
      const headerText = isMultiSession 
        ? `Multi-Session Class Conflict` 
        : `Timeslot Conflict`;
      
      const descriptionText = isMultiSession
        ? `This is a multi-session class (${conflictData.totalSessions} sessions). You are already enrolled in ${conflicts.length} class${conflicts.length > 1 ? 'es' : ''} during the timeslots this class requires:`
        : `You are already enrolled in another class during this timeslot.`;
      
      const actionText = isMultiSession && conflicts.length > 1
        ? `Would you like to drop these ${conflicts.length} classes and register for the new multi-session class?`
        : `Would you like to move to the new class?`;
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 550px;">
          <div class="modal-header">
            <h2>${headerText}</h2>
            <button onclick="closeModal('conflictModal')" class="btn btn-outline">×</button>
          </div>
          <div style="padding: 20px;">
            <p style="margin-bottom: 15px;">${descriptionText}</p>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <strong>Class${conflicts.length > 1 ? 'es' : ''} to be dropped:</strong>
              <ul style="margin: 10px 0 0 20px; padding: 0;">
                ${conflictListHtml}
              </ul>
            </div>
            <p style="margin-bottom: 20px;">${actionText}</p>
            <div style="display: flex; gap: 10px;">
              <button onclick="resolveConflictStudent('${newClassId}', '${registrationIds}')" class="btn btn-primary" style="flex: 1;">
                Yes, ${conflicts.length > 1 ? 'Drop All & Register' : 'Move Me'}
              </button>
              <button onclick="closeModal('conflictModal')" class="btn btn-outline" style="flex: 1;">
                No, Keep Current Class${conflicts.length > 1 ? 'es' : ''}
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    async function resolveConflictStudent(newClassId, conflictRegistrationIds) {
      try {
        // Parse the registration IDs (can be comma-separated for multi-session conflicts)
        const registrationIds = conflictRegistrationIds.split(',').filter(id => id.trim());
        
        // Drop all conflicting classes
        for (const regId of registrationIds) {
          const dropResponse = await fetchWithAuth(`/api/registrations/${regId}`, {
            method: 'DELETE'
          });
          
          if (!dropResponse.ok) {
            throw new Error(`Failed to drop class (registration ${regId})`);
          }
        }
        
        // Then, register for the new class (this will register for all sessions if multi-session)
        const registerResponse = await fetchWithAuth('/api/registrations', {
          method: 'POST',
          body: JSON.stringify({ ClassID: newClassId })
        });
        
        if (!registerResponse.ok) {
          const errorData = await registerResponse.json();
          throw new Error(errorData.error || 'Failed to register for new class');
        }
        
        // Close conflict modal
        closeModal('conflictModal');
        
        // Reload data
        await loadData();
        
        const message = registrationIds.length > 1 
          ? `Successfully dropped ${registrationIds.length} classes and registered for the new multi-session class!`
          : 'Successfully moved to new class!';
        showNotification(message, 'success');
      } catch (error) {
        showNotification('Error moving classes: ' + error.message, 'error');
      }
    }
    
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.remove();
      }
    }

    async function waitlist(classId) {
      if (!confirm('Join waitlist for this class?')) return;

      try {
        const response = await fetchWithAuth('/api/registrations', {
          method: 'POST',
          body: JSON.stringify({ ClassID: classId })
        });

        const data = await response.json();

        if (response.ok) {
          showNotification('Added to waitlist!', 'info');
          await loadData();
        } else {
          showNotification(data.error, 'error');
        }
      } catch (error) {
        showNotification('Error joining waitlist', 'error');
      }
    }

    async function dropClass(registrationId) {
      if (!confirm('Drop this class?')) return;

      try {
        const response = await fetchWithAuth(`/api/registrations/${registrationId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
          showNotification('Class dropped', 'info');
          await loadData();
        } else {
          showNotification(data.error, 'error');
        }
      } catch (error) {
        showNotification('Error dropping class', 'error');
      }
    }

    // Filter change handlers
    document.getElementById('timeslotFilter').addEventListener('change', renderClasses);
    document.getElementById('teacherFilter').addEventListener('change', renderClasses);
  </script>
  <footer style="text-align: center; padding: 20px; color: #666; font-size: 0.875rem; border-top: 1px solid #e0e0e0; margin-top: 40px;">
    Build Date: <span id="buildDate">2025-11-03 17:39:43</span>
  </footer>
</body>
</html>


