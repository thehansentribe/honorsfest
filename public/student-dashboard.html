<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - Honors Festival</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="top-banner">
    <h1>Honors Festival</h1>
    <div class="user-info">
      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <span id="eventSelectorContainer" style="display: none;">
          <select id="eventSelector" class="form-control" style="width: auto; min-width: 200px;" onchange="switchEvent()">
            <option value="">Select Event...</option>
          </select>
        </span>
        <span id="eventName" class="event-info"></span>
      </div>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <span id="userName">Welcome, <strong id="userDisplayName"></strong></span>
        <span id="checkInNumberDisplay" class="event-info" style="font-weight: bold;"></span>
        <button onclick="logout()" class="btn btn-outline">Logout</button>
      </div>
    </div>
  </div>

  <div id="eventStatusBanner" style="display: none;" class="status-banner status-banner-closed">
    <strong>⚠ Registration Not Open:</strong> You can view classes and your registered classes, but registration is not currently open for this event.
  </div>

  <div class="container">
    <div id="notifications"></div>

    <div class="dashboard-split">
      <!-- Left Panel: Class Browser -->
      <div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Available Classes</h2>
          </div>

          <div class="class-filters">
            <select id="timeslotFilter" class="form-control">
              <option value="">All Timeslots</option>
            </select>
            <select id="teacherFilter" class="form-control">
              <option value="">All Teachers</option>
            </select>
          </div>

          <div id="classesList" class="mt-2">
            <p class="text-center">Loading classes...</p>
          </div>
        </div>
      </div>

      <!-- Right Panel: Calendar Grid -->
      <div>
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">My Schedule</h2>
          </div>
          <div id="scheduleGrid">
            <p class="text-center">Loading schedule...</p>
          </div>
        </div>

        <!-- Registered and Waitlisted Classes -->
        <div class="card mt-2">
          <div class="card-header">
            <h2 class="card-title">My Classes</h2>
          </div>
          <div id="myClasses">
            <p class="text-center">Loading...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/utils.js"></script>
  <script>
    let currentEventId = null;
    let currentUserId = null;
    let allClasses = [];
    let myRegistrations = [];
    let availableEvents = [];

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', async () => {
      if (!checkAuth()) return;

      const user = getCurrentUser();
      currentUserId = user.id;
      document.getElementById('userDisplayName').textContent = `${user.firstName} ${user.lastName}`;

      // Load user details to get check-in number
      try {
        const userResponse = await fetchWithAuth(`/api/users/${user.id}`);
        const userDetails = await userResponse.json();
        if (userDetails && userDetails.CheckInNumber) {
          document.getElementById('checkInNumberDisplay').textContent = `Check-In: #${userDetails.CheckInNumber}`;
        }
      } catch (error) {
        console.error('Error loading user details:', error);
      }

      await loadEvents();
      await loadData();
    });

    async function loadEvents() {
      try {
        // Get events where user's club participates
        const response = await fetchWithAuth('/api/events/my');
        availableEvents = await response.json();
        
        if (availableEvents.length === 0) {
          document.getElementById('eventName').textContent = 'No events available';
          showNotification('Your club is not participating in any active events.', 'info');
          return;
        }

        // Show event selector if multiple events
        const eventSelectorContainer = document.getElementById('eventSelectorContainer');
        const eventSelector = document.getElementById('eventSelector');
        const eventNameSpan = document.getElementById('eventName');

        if (availableEvents.length > 1) {
          eventSelectorContainer.style.display = 'block';
          eventSelector.innerHTML = '<option value="">Select Event...</option>';
          availableEvents.forEach(event => {
            const option = document.createElement('option');
            option.value = event.ID;
            option.textContent = `${event.Name} (${event.Status})`;
            eventSelector.appendChild(option);
          });
        } else {
          eventSelectorContainer.style.display = 'none';
        }

        // Get saved event from localStorage or default to first Live event or first event
        const savedEventId = localStorage.getItem('selectedEventId');
        let selectedEvent = availableEvents.find(e => e.ID.toString() === savedEventId) ||
                          availableEvents.find(e => e.Status === 'Live') ||
                          availableEvents[0];

        if (selectedEvent) {
          currentEventId = selectedEvent.ID;
          eventNameSpan.textContent = selectedEvent.Name;
          if (eventSelector) {
            eventSelector.value = selectedEvent.ID;
          }
          
          // Save to localStorage
          localStorage.setItem('selectedEventId', selectedEvent.ID);
          
          // Update status banner
          await checkEventStatus(selectedEvent);
        }
      } catch (error) {
        console.error('Error loading events:', error);
        showNotification('Error loading events: ' + error.message, 'error');
      }
    }

    async function switchEvent() {
      const eventSelector = document.getElementById('eventSelector');
      const selectedEventId = parseInt(eventSelector.value);
      
      if (!selectedEventId) {
        return;
      }

      const selectedEvent = availableEvents.find(e => e.ID === selectedEventId);
      if (!selectedEvent) {
        return;
      }

      currentEventId = selectedEventId;
      document.getElementById('eventName').textContent = selectedEvent.Name;
      localStorage.setItem('selectedEventId', selectedEventId);
      
      await checkEventStatus(selectedEvent);
      await loadData();
    }

    async function checkEventStatus(event = null) {
      try {
        // If event not provided, get current event
        if (!event && currentEventId) {
          const response = await fetchWithAuth(`/api/events/${currentEventId}`);
          event = await response.json();
        }

        if (!event) return;
        
        const banner = document.getElementById('eventStatusBanner');
        
        // Show banner if event is not Live (Closed or not Live yet)
        if (event.Status !== 'Live') {
          banner.style.display = 'block';
          banner.className = 'status-banner status-banner-closed';
          if (event.Status === 'Closed') {
            banner.innerHTML = '<strong>⚠ Registration Not Open:</strong> Registration is closed for this event. You can view classes but cannot register.';
          } else {
            banner.innerHTML = '<strong>⚠ Registration Not Open:</strong> Registration is not yet open for this event. You can view classes but cannot register.';
          }
        } else {
          banner.style.display = 'none';
        }
      } catch (error) {
        console.error('Error checking event status:', error);
      }
    }

    async function loadData() {
      if (!currentEventId) return;

      try {
        // Load classes
        const classesResponse = await fetchWithAuth(`/api/classes/${currentEventId}`);
        allClasses = await classesResponse.json();

        // Load my registrations
        const regResponse = await fetchWithAuth(`/api/registrations/user/${currentUserId}?eventId=${currentEventId}`);
        myRegistrations = await regResponse.json();

        // Load filters
        await loadFilters();
        renderClasses();
        renderSchedule();
        renderMyClasses();
      } catch (error) {
        console.error('Error loading data:', error);
        showNotification('Error loading data', 'error');
      }
    }

    async function loadFilters() {
      try {
        // Load timeslots
        const timeslotsResponse = await fetchWithAuth(`/api/timeslots/event/${currentEventId}`);
        const timeslots = await timeslotsResponse.json();
        
        const timeslotSelect = document.getElementById('timeslotFilter');
        timeslots.forEach(ts => {
          const option = document.createElement('option');
          option.value = ts.ID;
          // Format timeslot for display
          function convertTo12Hour(time24) {
            if (!time24) return '';
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
          }
          option.textContent = `${ts.Date} - ${convertTo12Hour(ts.StartTime)} to ${convertTo12Hour(ts.EndTime)}`;
          timeslotSelect.appendChild(option);
        });
        
        // Load teachers
        const teachersMap = new Map();
        allClasses.forEach(c => {
          if (c.TeacherID && c.TeacherFirstName && c.TeacherLastName) {
            const key = `${c.TeacherID}`;
            if (!teachersMap.has(key)) {
              teachersMap.set(key, {
                id: c.TeacherID,
                name: `${c.TeacherFirstName} ${c.TeacherLastName}`
              });
            }
          }
        });
        
        const teacherSelect = document.getElementById('teacherFilter');
        Array.from(teachersMap.values()).sort((a, b) => a.name.localeCompare(b.name)).forEach(teacher => {
          const option = document.createElement('option');
          option.value = teacher.id;
          option.textContent = teacher.name;
          teacherSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading filters:', error);
      }
    }

    function renderClasses() {
      const container = document.getElementById('classesList');
      const timeslotFilter = document.getElementById('timeslotFilter').value;
      const teacherFilter = document.getElementById('teacherFilter').value;

      // Get current event status to determine if registration is allowed
      const currentEvent = availableEvents.find(e => e.ID === currentEventId);
      const isEventLive = currentEvent && currentEvent.Status === 'Live';

      // Filter classes - make sure we're not deduplicating
      const filtered = allClasses.filter(c => {
        // Always filter out inactive classes from student view
        if (!c.Active) return false;
        
        if (timeslotFilter && c.TimeslotID && c.TimeslotID.toString() !== timeslotFilter) return false;
        if (teacherFilter && c.TeacherID && c.TeacherID.toString() !== teacherFilter) return false;
        return true;
      });

      
      // Count classes by honor name and timeslot to check for duplicates
      const classesByHonorTimeslot = {};
      filtered.forEach(c => {
        const key = `${c.HonorName}_${c.TimeslotID}`;
        if (!classesByHonorTimeslot[key]) {
          classesByHonorTimeslot[key] = [];
        }
        classesByHonorTimeslot[key].push({
          ID: c.ID,
          Teacher: `${c.TeacherFirstName || ''} ${c.TeacherLastName || ''}`.trim() || 'TBA',
          Location: c.LocationName || 'TBA'
        });
      });

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-center">No classes available</p>';
        return;
      }

      const tableData = (() => {
        let renderedCount = 0;
        return filtered.map(c => {
                const location = `${c.LocationName || 'TBA'}`;
                const teacher = c.TeacherFirstName ? `${c.TeacherFirstName} ${c.TeacherLastName}` : 'TBA';
                
                // Check if user is registered for this class
                const isRegistered = myRegistrations.some(r => r.ClassID === c.ID);
              
              // Check if user has an enrolled class in this timeslot
              const hasEnrolledInTimeslot = myRegistrations.some(r => {
                return r.TimeslotID === c.TimeslotID && r.Status === 'Enrolled';
              });
              
              // Check if user has a waitlist spot for this class or any class in this timeslot
              const hasWaitlistForThisClass = myRegistrations.some(r => r.ClassID === c.ID && r.Status === 'Waitlisted');
              const hasWaitlistInTimeslot = myRegistrations.some(r => {
                return r.TimeslotID === c.TimeslotID && r.Status === 'Waitlisted';
              });
              
              const isFull = c.RemainingSpots <= 0;
              
              // Can register if: not registered for this class, not enrolled in timeslot, class not full
              const canRegister = !isRegistered && !hasEnrolledInTimeslot && !isFull;
              
              // Can waitlist if: not registered for this class, not waitlisted in timeslot, class is full
              const canWaitlist = !isRegistered && !hasWaitlistInTimeslot && isFull;
              
              // Format session time
              function convertTo12Hour(time24) {
                if (!time24) return '';
                const [hours, minutes] = time24.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
              }
              
              const sessionTime = c.TimeslotDate && c.TimeslotStartTime && c.TimeslotEndTime
                ? `${c.TimeslotDate}<br><small>${convertTo12Hour(c.TimeslotStartTime)} - ${convertTo12Hour(c.TimeslotEndTime)}</small>`
                : 'TBA';

              // Don't show this class at all if they're already registered for it
              if (isRegistered) {
                return null;
              }

              renderedCount++;

              // Determine action buttons - only show if event is Live
              let actionButtons = '';
              if (!isEventLive) {
                actionButtons = '<span style="color: #999;">Registration not open</span>';
              } else if (canRegister) {
                actionButtons = `<button onclick="register(${c.ID})" class="btn btn-primary btn-sm">Register</button>`;
              } else if (hasEnrolledInTimeslot && !canWaitlist && !isFull) {
                // Show light blue register button when there's a timeslot conflict (not full)
                actionButtons = `<button onclick="register(${c.ID})" class="btn btn-sm" style="background-color: #87CEEB; color: #000; border-color: #87CEEB;">Register</button>`;
              } else if (canWaitlist) {
                actionButtons = `<button onclick="waitlist(${c.ID})" class="btn btn-warning btn-sm">Waitlist</button>`;
              } else if (hasWaitlistInTimeslot && !canRegister) {
                actionButtons = '<span style="color: #999;">Already waitlisted for another class at this time</span>';
              }
              
              // Ensure each class is uniquely displayed - show all distinguishing info
              // Include class ID in data attribute for debugging
              // Make sure teacher and location are always visible, even if "TBA"
              const displayTeacher = teacher === 'TBA' ? '<span style="color: #999;">TBA</span>' : teacher;
              const displayLocation = location === 'TBA' ? '<span style="color: #999;">TBA</span>' : location;
              
              return {
                classId: c.ID,
                honorId: c.HonorID || '',
                teacherId: c.TeacherID || '',
                locationId: c.LocationID || '',
                timeslotId: c.TimeslotID || '',
                honorName: c.HonorName || 'Unknown',
                teacher: displayTeacher,
                location: displayLocation,
                sessionTime: sessionTime,
                remainingSpots: c.RemainingSpots,
                actionButtons: actionButtons,
                canRegister: canRegister,
                canWaitlist: canWaitlist,
                isFull: isFull
              };
            }).filter(data => data !== null);
      })();
      
      const tableHtml = `
        <table class="table">
          <thead>
            <tr>
              <th>Honor Name</th>
              <th>Teacher</th>
              <th>Location</th>
              <th>Session Time</th>
              <th>Remaining Spots</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${tableData.map(c => `
              <tr data-class-id="${c.classId}" data-honor-id="${c.honorId}" data-teacher-id="${c.teacherId}" data-location-id="${c.locationId}" data-timeslot-id="${c.timeslotId}">
                <td>${c.honorName}</td>
                <td>${c.teacher}</td>
                <td>${c.location}</td>
                <td>${c.sessionTime}</td>
                <td>${c.remainingSpots}</td>
                <td>
                  ${c.actionButtons}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      const mobileCards = tableData.map(c => {
        // Convert HTML session time to plain text
        const sessionTimePlain = c.sessionTime.replace(/<br\s*\/?>/gi, ' ').replace(/<small>/gi, '').replace(/<\/small>/gi, '').replace(/<[^>]*>/g, '').trim();
        
        return createMobileCard({
          'Honor Name': c.honorName,
          'Teacher': c.teacher.replace(/<[^>]*>/g, ''), // Strip HTML tags
          'Location': c.location.replace(/<[^>]*>/g, ''), // Strip HTML tags
          'Session Time': sessionTimePlain,
          'Remaining Spots': c.remainingSpots
        }, c.honorName, `<div class="card-row-actions">${c.actionButtons}</div>`);
      }).join('');
      
      container.innerHTML = wrapResponsiveTable(tableHtml, mobileCards);
    }

    function renderSchedule() {
      // Simplified schedule view for now
      const container = document.getElementById('scheduleGrid');
      const enrolled = myRegistrations.filter(r => r.Status === 'Enrolled');
      
      if (enrolled.length === 0) {
        container.innerHTML = '<p class="text-center">No enrolled classes</p>';
        return;
      }

      container.innerHTML = `
        <div class="timeslot-grid">
          <div class="timeslot-row">
            <strong>Timeslot</strong>
            <strong>Class</strong>
          </div>
          ${enrolled.map(r => `
            <div class="timeslot-row">
              <span>${formatDateTime(r.TimeslotDate, r.TimeslotStartTime, r.TimeslotEndTime)}</span>
              <span>
                <strong>${r.HonorName}</strong><br>
                <small>${r.TeacherFirstName} ${r.TeacherLastName}</small>
              </span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderMyClasses() {
      const container = document.getElementById('myClasses');
      
      if (myRegistrations.length === 0) {
        container.innerHTML = '<p class="text-center">No registered classes</p>';
        return;
      }

      const enrolled = myRegistrations.filter(r => r.Status === 'Enrolled');
      const waitlisted = myRegistrations.filter(r => r.Status === 'Waitlisted');

      container.innerHTML = `
        <h3>Registered Classes (${enrolled.length})</h3>
        ${enrolled.map(r => `
          <div style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.25rem; margin-bottom: 0.5rem;">
            <strong>${r.HonorName}</strong><br>
            <small>${formatDateTime(r.TimeslotDate, r.TimeslotStartTime, r.TimeslotEndTime)}</small><br>
            <button onclick="dropClass(${r.ID})" class="btn btn-danger btn-sm mt-1">Drop</button>
          </div>
        `).join('')}
        
        ${waitlisted.length > 0 ? `
          <h3 class="mt-2">Waitlisted Classes (${waitlisted.length})</h3>
          ${waitlisted.map(r => `
            <div style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.25rem; margin-bottom: 0.5rem;">
              <strong>${r.HonorName}</strong><br>
              <small>Position ${r.WaitlistOrder} - ${formatDateTime(r.TimeslotDate, r.TimeslotStartTime, r.TimeslotEndTime)}</small><br>
              <button onclick="dropClass(${r.ID})" class="btn btn-danger btn-sm mt-1">Drop Waitlist</button>
            </div>
          `).join('')}
        ` : ''}
      `;
    }

    async function register(classId) {
      try {
        const response = await fetchWithAuth('/api/registrations', {
          method: 'POST',
          body: JSON.stringify({ ClassID: classId })
        });

        const data = await response.json();

        if (response.ok) {
          showNotification('Successfully registered!', 'success');
          await loadData();
        } else if (response.status === 409 && data.conflict) {
          // Show conflict modal for student
          showConflictModalStudent(classId, data.conflictClassName, data.conflictRegistrationId);
        } else {
          showNotification(data.error, 'error');
        }
      } catch (error) {
        showNotification('Error registering', 'error');
      }
    }
    
    function showConflictModalStudent(newClassId, conflictClassName, conflictRegistrationId) {
      const modal = document.createElement('div');
      modal.id = 'conflictModal';
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h2>Timeslot Conflict</h2>
            <button onclick="closeModal('conflictModal')" class="btn btn-outline">×</button>
          </div>
          <div style="padding: 20px;">
            <p style="margin-bottom: 20px;">You are already enrolled in another class during this timeslot.</p>
            <p style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
              <strong>Current Class:</strong> ${conflictClassName}
            </p>
            <p style="margin-bottom: 20px;">Would you like to move to the new class?</p>
            <div style="display: flex; gap: 10px;">
              <button onclick="resolveConflictStudent('${newClassId}', '${conflictRegistrationId}')" class="btn btn-primary" style="flex: 1;">
                Yes, Move Me
              </button>
              <button onclick="closeModal('conflictModal')" class="btn btn-outline" style="flex: 1;">
                No, Keep Current Class
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    async function resolveConflictStudent(newClassId, conflictRegistrationId) {
      try {
        // First, drop the conflict class
        const dropResponse = await fetchWithAuth(`/api/registrations/${conflictRegistrationId}`, {
          method: 'DELETE'
        });
        
        if (!dropResponse.ok) {
          throw new Error('Failed to drop current class');
        }
        
        // Then, register for the new class
        const registerResponse = await fetchWithAuth('/api/registrations', {
          method: 'POST',
          body: JSON.stringify({ ClassID: newClassId })
        });
        
        if (!registerResponse.ok) {
          throw new Error('Failed to register for new class');
        }
        
        // Close conflict modal
        closeModal('conflictModal');
        
        // Reload data
        await loadData();
        
        showNotification('Successfully moved to new class!', 'success');
      } catch (error) {
        showNotification('Error moving classes: ' + error.message, 'error');
      }
    }
    
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.remove();
      }
    }

    async function waitlist(classId) {
      if (!confirm('Join waitlist for this class?')) return;

      try {
        const response = await fetchWithAuth('/api/registrations', {
          method: 'POST',
          body: JSON.stringify({ ClassID: classId })
        });

        const data = await response.json();

        if (response.ok) {
          showNotification('Added to waitlist!', 'info');
          await loadData();
        } else {
          showNotification(data.error, 'error');
        }
      } catch (error) {
        showNotification('Error joining waitlist', 'error');
      }
    }

    async function dropClass(registrationId) {
      if (!confirm('Drop this class?')) return;

      try {
        const response = await fetchWithAuth(`/api/registrations/${registrationId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
          showNotification('Class dropped', 'info');
          await loadData();
        } else {
          showNotification(data.error, 'error');
        }
      } catch (error) {
        showNotification('Error dropping class', 'error');
      }
    }

    // Filter change handlers
    document.getElementById('timeslotFilter').addEventListener('change', renderClasses);
    document.getElementById('teacherFilter').addEventListener('change', renderClasses);
  </script>
</body>
</html>


